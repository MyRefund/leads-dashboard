<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Language" content="en">
<meta name="google" content="notranslate">

<title>My Refund — Leads Management</title>

<style>
:root{
  --g0:#094B35;
  --g1:#03953F;
  --g2:#ECFDF5;
  --text:#111827;
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Okta Neue", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:#f9fafb;
  color:var(--text);
}

/* HEADER */
.header{background:var(--g0);color:#fff;padding:18px 28px}
.header-inner{max-width:1300px;margin:0 auto;display:flex;align-items:center}
.brand img{height:28px}

/* NAV */
.nav-tabs{background:#fff;border-bottom:1px solid #e5e7eb}
.nav-inner{max-width:1300px;margin:0 auto;padding:0 24px;display:flex;gap:30px}
.nav-tab{
  padding:16px 0;font-weight:900;font-size:14px;cursor:pointer;
  color:#6b7280;border-bottom:3px solid transparent
}
.nav-tab.active{color:var(--g0);border-bottom:3px solid var(--g1)}

/* PAGE */
.page-wrapper{max-width:1300px;margin:50px auto;padding:0 24px 80px}
.section-title{font-size:20px;font-weight:900;color:var(--g0);margin-bottom:18px}

/* CARDS */
.card-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:22px;margin-bottom:40px
}
.card{background:#fff;border-radius:var(--radius);padding:28px;box-shadow:0 4px 25px rgba(0,0,0,.05)}
.card h3{margin:0;font-size:13px;font-weight:900;color:var(--g0);text-transform:uppercase;letter-spacing:.4px}
.card p{margin:14px 0 0;font-size:34px;font-weight:900;color:var(--g1)}

/* FORMS */
.form-grid{display:grid;gap:14px;max-width:620px;margin-bottom:26px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row > *{flex:1}

input,select{
  padding:12px 14px;border-radius:14px;border:1px solid #e5e7eb;
  font-size:14px;width:100%
}

.primary-btn{
  background:var(--g0);color:#fff;border:none;border-radius:14px;
  padding:12px 18px;font-weight:900;cursor:pointer
}
.primary-btn:hover{background:#0b5c42}

.secondary-btn{
  background:#fff;color:var(--g0);border:1px solid var(--g0);
  border-radius:14px;padding:12px 18px;font-weight:900;cursor:pointer
}
.secondary-btn:hover{background:var(--g2)}

.note{font-size:13px;color:#6b7280;margin-top:6px}
.small{font-size:12px;color:#6b7280}

/* BANNERS */
.banner{
  display:none;padding:14px 16px;border-radius:14px;font-weight:900;margin:10px 0 22px
}
.banner.success{background:#ECFDF5;border:1px solid #BBF7D0;color:var(--g0)}
.banner.error{background:#FEF2F2;border:1px solid #FECACA;color:#7F1D1D}

/* PAGES */
.page{display:none}
.page.active{display:block}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.png" alt="My Refund">
    </div>
  </div>
</div>

<div class="nav-tabs">
  <div class="nav-inner">
    <div class="nav-tab active" data-page="dashboard">Dashboard</div>
    <div class="nav-tab" data-page="lists">Lists</div>
    <div class="nav-tab" data-page="campaigns">Campaigns</div>
  </div>
</div>

<div class="page-wrapper">

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="section-title">Database Overview</div>
    <div class="banner" id="banner-dashboard"></div>

    <div class="card-grid">
      <div class="card"><h3>Total Leads</h3><p id="stat-total">—</p></div>
      <div class="card"><h3>Active</h3><p id="stat-active">—</p></div>
      <div class="card"><h3>Signed Up</h3><p id="stat-signed">—</p></div>
      <div class="card"><h3>Removed</h3><p id="stat-removed">—</p></div>
    </div>

    <button class="secondary-btn" onclick="loadStats(true)">Refresh</button>
    <div class="note">Stats are live from Google Sheets.</div>
  </div>

  <!-- LISTS -->
  <div class="page" id="page-lists">
    <div class="section-title">Upload List (CSV)</div>
    <div class="banner" id="banner-lists"></div>

    <div class="form-grid">
      <input type="text" id="list-name" placeholder="List Name (e.g. Drop Offs 27/02)" />

      <div class="row">
        <select id="list-type">
          <option value="Lead Upload">Lead Upload</option>
          <option value="Signed Up Import">Signed Up Import</option>
          <option value="Removal Import">Removal Import</option>
        </select>

        <select id="channel">
          <option value="Email">Email</option>
          <option value="SMS">SMS</option>
        </select>
      </div>

      <input type="file" id="csv-file" accept=".csv" />
      <button class="primary-btn" id="btn-upload" onclick="uploadCsv()">Upload</button>

      <div class="small">
        CSV should be one column. If it has multiple columns, we use the first column only.
      </div>
    </div>
  </div>

  <!-- CAMPAIGNS -->
  <div class="page" id="page-campaigns">
    <div class="section-title">Generate & Export Campaign</div>
    <div class="banner" id="banner-campaigns"></div>

    <div class="form-grid">
      <input type="text" id="campaign-name" placeholder="Campaign Name (required)" />

      <div class="row">
        <select id="campaign-type">
          <option value="Email">Email</option>
          <option value="SMS">SMS</option>
        </select>

        <input type="number" id="export-limit" placeholder="How many to export (e.g. 5000)" min="1" />
      </div>

      <select id="campaign-list">
        <option value="">All Leads (no list filter)</option>
      </select>

      <div class="note">
        Rules: Active only, channel matched, and not contacted in the last <strong>7 days</strong>.
        Signed Up and Removed are automatically excluded.
      </div>

      <button class="primary-btn" id="btn-export" onclick="generateExport()">Generate & Download CSV</button>

      <div class="small">
        This action will: (1) generate the CSV, (2) log the campaign, and (3) update counters + last contact date
        <strong>only for the exported leads</strong>.
      </div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbya6ZUeAB7-HC8ImkkeSy4llDelebL6dhPHEPTQiweiggqz-hIn3oZ-Lus3ANnZcTO42Q/exec";

/* =========================
   NAV
========================= */
const tabs = document.querySelectorAll(".nav-tab");
const pages = document.querySelectorAll(".page");
tabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    tabs.forEach(t=>t.classList.remove("active"));
    pages.forEach(p=>p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("page-"+tab.dataset.page).classList.add("active");
  });
});

/* =========================
   UI HELPERS
========================= */
function showBanner(id, type, msg){
  const el = document.getElementById(id);
  el.className = "banner " + type;
  el.textContent = msg;
  el.style.display = "block";
}

function hideBanner(id){
  const el = document.getElementById(id);
  el.style.display = "none";
  el.textContent = "";
  el.className = "banner";
}

function setBusy(buttonId, busy, busyText){
  const btn = document.getElementById(buttonId);
  if(!btn) return;
  if(!btn.dataset.original) btn.dataset.original = btn.textContent;
  btn.disabled = busy;
  btn.textContent = busy ? busyText : btn.dataset.original;
}

/* =========================
   DASHBOARD STATS
========================= */
async function loadStats(showMessage){
  hideBanner("banner-dashboard");
  try{
    const res = await fetch(API_URL + "?action=stats", { method:"GET" });
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    document.getElementById("stat-total").textContent = data.total;
    document.getElementById("stat-active").textContent = data.active;
    document.getElementById("stat-signed").textContent = data.signed;
    document.getElementById("stat-removed").textContent = data.removed;

    if(showMessage) showBanner("banner-dashboard","success","Dashboard updated successfully.");
  }catch(err){
    showBanner("banner-dashboard","error","Could not load stats. " + err.message);
  }
}

/* =========================
   LOAD LISTS DROPDOWN
========================= */
async function loadListsDropdown(){
  try{
    const res = await fetch(API_URL + "?action=lists", { method:"GET" });
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const select = document.getElementById("campaign-list");
    // keep first option
    const first = select.querySelector('option[value=""]');
    select.innerHTML = "";
    select.appendChild(first);

    (data.lists || []).forEach(l=>{
      const opt = document.createElement("option");
      opt.value = l.listId;
      opt.textContent = `${l.listName}  —  ${l.channel || "?"}  —  ${l.listType || ""}`;
      select.appendChild(opt);
    });
  }catch(e){
    // non-blocking: dropdown still usable with "All Leads"
  }
}

/* =========================
   CSV PARSER (FIRST COLUMN)
========================= */
function parseCsvFirstColumn(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const cleaned = lines.map(l=>{
    const first = l.split(",")[0].trim().replace(/^"|"$/g,"");
    return first;
  }).filter(Boolean);
  return Array.from(new Set(cleaned));
}

/* =========================
   LIST UPLOAD
========================= */
async function uploadCsv(){
  hideBanner("banner-lists");

  const listName = document.getElementById("list-name").value.trim();
  const listType = document.getElementById("list-type").value;
  const channel = document.getElementById("channel").value;
  const file = document.getElementById("csv-file").files[0];

  if(!listName){
    showBanner("banner-lists","error","Please enter a list name.");
    return;
  }
  if(!file){
    showBanner("banner-lists","error","Please select a CSV file.");
    return;
  }

  setBusy("btn-upload", true, "Uploading...");

  try{
    const text = await file.text();
    const records = parseCsvFirstColumn(text);

    if(records.length === 0) throw new Error("No valid records found in the CSV.");

    let action = "uploadList";
    if(listType === "Signed Up Import") action = "uploadSignedUp";
    if(listType === "Removal Import") action = "uploadRemoval";

    const res = await fetch(API_URL, {
      method:"POST",
      body: JSON.stringify({ action, listName, channel, records })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const msgParts = [];
    msgParts.push(`Upload complete: ${data.processed || records.length} processed.`);
    if(typeof data.created === "number") msgParts.push(`${data.created} new, ${data.reused} existing.`);
    if(typeof data.matched === "number") msgParts.push(`${data.matched} matched, ${data.skipped} skipped.`);
    showBanner("banner-lists","success", msgParts.join(" "));

    document.getElementById("csv-file").value = "";
    loadStats(false);
    loadListsDropdown(); // refresh list dropdown
  }catch(err){
    showBanner("banner-lists","error","Upload failed. " + err.message);
  }finally{
    setBusy("btn-upload", false, "Upload");
  }
}

/* =========================
   CONTROLLED EXPORT
========================= */
async function generateExport(){
  hideBanner("banner-campaigns");

  const campaignName = document.getElementById("campaign-name").value.trim();
  const campaignType = document.getElementById("campaign-type").value;
  const limit = Number(document.getElementById("export-limit").value || 0);
  const listId = document.getElementById("campaign-list").value || "";
  const minDays = 7;

  if(!campaignName){
    showBanner("banner-campaigns","error","Campaign name is required.");
    return;
  }
  if(!limit || limit < 1){
    showBanner("banner-campaigns","error","Please enter how many to export (e.g. 5000).");
    return;
  }

  setBusy("btn-export", true, "Generating...");

  try{
    const res = await fetch(API_URL, {
      method:"POST",
      body: JSON.stringify({
        action:"generateCampaignExport",
        campaignName,
        campaignType,
        listId,
        limit,
        minDays
      })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error);

    const csv = data.csv || "contact\n";
    const filename = data.filename || "export.csv";
    const total = Number(data.totalRecipients || 0);

    downloadCsv(csv, filename);

    showBanner(
      "banner-campaigns",
      "success",
      `Export generated: ${total} recipients. Campaign logged and counters updated.`
    );

    loadStats(false);
  }catch(err){
    showBanner("banner-campaigns","error","Export failed. " + err.message);
  }finally{
    setBusy("btn-export", false, "Generate & Download CSV");
  }
}

function downloadCsv(csvText, filename){
  const blob = new Blob([csvText], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* =========================
   INIT
========================= */
loadStats(false);
loadListsDropdown();
</script>

</body>
</html>
